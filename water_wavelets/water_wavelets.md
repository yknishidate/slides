# Water Surface Wavelets

STEFAN JESCHKE, NVIDIA

TOMÁŠ SKŘIVAN, IST Austria

MATTHIAS MÜLLER-FISCHER, NVIDIA

NUTTAPONG CHENTANEZ, NVIDIA

MILES MACKLIN, NVIDIA

CHRIS WOJTAN, IST Austria

最先端のリアルタイム2次元水面波シミュレーションでは、開発者は「効率的だが移動する障害物との相互作用を扱えないフーリエベース手法」と、「環境との相互作用は扱えるが計算コストが大幅に高い有限差分法／有限要素法」のどちらかを選ばざるを得ません。本論文は、移動する障害物との波の相互作用をリアルタイムに忠実にシミュレートしつつ、微細なディテールも保ち、非常に大きなシミュレーション領域にも対応できる新しい波シミュレーション手法を提案することで、この複雑さと性能の間に長らく存在してきたギャップを埋めることを目指します。  

従来の2D水面波シミュレーション手法は、水面高さの変化を直接計算しますが、この戦略はCFL条件（速い波には小さなタイムステップが必要）と、ナイキスト限界（小さな波のディテールには密なシミュレーション変数配置が必要）による制約を受けます。そこで本論文は、液体の運動を「空間・周波数・方向」にわたって変化する“振幅に似た関数”で離散化する、新しいウェーブレット変換を提案します。これはフーリエベース手法を局所的相互作用まで扱えるように一般化したものです。これらの新しい変数は元の水面高さ関数よりも空間的にずっとゆっくり変化するため、変数変換によってCFL条件とナイキスト限界の制約を大幅に緩和し、非常に高い見た目解像度で高度に詳細な水面波をシミュレートできるようになります。さらに、この離散化は高速な総和計算に適し、並列化も容易です。加えて、事前計算した波の経路や、双方向の固体–流体カップリングといった基本的拡張も示します。最後に、この離散化がアート的な操作（演出）に便利な変数系を提供することを主張し、新しい「波を描く」インタフェースでそれを例示します。 

## 1 INTRODUCTION

本論文は、大規模な水面波について、効率的で物理的にもっともらしいアニメーション生成とアートディレクションを扱う。現在この問題に対する解決策としては、（浅水方程式や分散波動方程式のような）偏微分方程式の数値解法、あるいはフーリエ変換に基づく解析的手法が用いられている。数値解法は移動する障害物との水の相互作用を扱うのが得意だが、小さな（高周波の）波のディテールを保ったまま非常に大きなシミュレーション領域へスケールさせると計算コストが高くなる。逆に、フーリエ総和（Fourier summation）技術は、高周波ディテールを伴う非常に大きな領域のシミュレーションを得意とする一方で、移動境界や空間的に変化する風のような複雑な環境相互作用を容易には組み込めない。 

本研究では、水面波計算を高速化するための新しい変換を提案する。従来の有限差分法のように格子上の各点で波高と運動量を離散化するのでもなく、従来のフーリエベース手法のように周波数と方向の関数として波の振幅を離散化するのでもなく、空間・周波数・方向を同時に変数として波の振幅を離散化するウェーブレット変換を導入する。この離散化で得られる変数は、元の水面波高関数よりも空間的にずっとゆっくり変化するため、同じ量の情報をより少ない変数で表現できる。さらに、この低周波なシミュレーションは、CFL条件やナイキスト限界といった従来の「周波数に基づく制約」に対して感度が低い。これらの制約は最大空間周波数を、タイムステップの大きさや見た目のディテールに対する制限へと変換してしまうが、提案離散化ではその影響を抑えられる。その結果、本離散化は（フーリエベース手法のような）高解像度の波ディテールと、移動する障害物との局所的な波の相互作用の両方を可能にする。 

また、これらの局所的で周波数依存の振幅を空間内で伝播させるための新しい方程式を導出する。得られる方程式は単純な2次元の移流（advection）と拡散（diffusion）操作になり、グラフィックスハードウェア上で容易に並列化できるため、対話的なフレームレートを実現できる。さらに、事前計算された波の経路（pre-computed wave paths）や、双方向の固体–流体カップリング（two-way solid fluid coupling）など、シミュレータの基本的拡張も示す。最後に、この新しい表現が複雑な海洋シミュレーションの動きを手作業で調整するのに便利なアート向けインタフェースを提供することを見いだし、シミュレーションの初期化やスクリプトによる動きで物理を上書きするための、波を描く（wave-painting）インタフェースのプロトタイプを示す。 

本論文の貢献は以下の通りである。 

* **Eulerian Wavelet Transformation（オイラー型ウェーブレット変換）**：ゆっくり変調された波（slowly modulated waves）の理論に基づく、水面波輸送のための新しい理論モデル。 
* **低周波のシミュレーション変数**：水面高さそのものよりも空間的にゆっくり変化する関数に基づいて離散化するため、より低解像度の格子で表現できる。この変数変換により、計算をより効率化し、より大きな計算領域（Figure 1）を扱える。 
* **新しいアート的制御**：物理運動方程式で振幅関数を決めることに加え、アート的効果のためにこれらの波の振幅を上書きすることも試す。本手法を用いることで、従来研究よりも速く・容易に波シーンを事前計算できることを示し、空間的に変化する海洋波を設計するための対話的ペイントUIを提示する。 

## 2 関連研究（RELATED WORK）

コンピュータアニメーションの黎明期（Schachter 1980）以来、水面形状とその運動を復元するための主要な戦略は、ナビエ–ストークス方程式を近似的に解くことでした。これらの方程式を近似する方法は数多く存在し、本節では手法を、解析的な「スペクトルベース」アプローチ、偏微分方程式（PDE）の直接的な数値シミュレーション、そしてハイブリッド手法に分類して議論します。最後に、波のシミュレーションをアートディレクションするための方法について述べます。 

### スペクトルベースのアプローチ（Spectrum-based approaches）

物理学およびコンピュータグラフィックスの両分野では、ナビエ–ストークス方程式に対して多くの理論的仮定を置くことで複雑さを減らし、解析的に扱える形にしています。コンピュータグラフィックスで一般的な仮定としては、深水、ポテンシャル流れ、小振幅、周期境界条件などがあります。これらのアプローチは、2Dの高さ場におけるナビエ–ストークス方程式の解析解を利用し、海の運動を正弦・余弦の形で表現しますが、任意の流体運動をシミュレートする能力は犠牲にします（Hinsinger et al. 2002; Horvath 2015; Mastin et al. 1987; Tessendorf 2004b）。Jeschke & Wojtan（2015）は、静的な環境内で波面の伝播をシミュレートすることで、複雑な境界を扱えるようスペクトルベース手法を拡張しました。しかし、この手法は事前計算に限定され、移動する障害物との相互作用は扱えません。 

本論文では、フーリエ変換を離散化するこの種の手法を「スペクトルベース」アプローチと呼びます。これらの手法は理論上、視覚的ディテールに上限がありません。すなわち、任意に高周波な波をアニメーションしても、手法の精度や安定性に影響しないという意味です。同様に、波速が速い場合でも、運動がタイムステップ幅に依存しないためシミュレーションは容易です。一方で、導出において基礎となる流れに複数の仮定を置くため、複雑な境界と現実的に相互作用できない、といった制約が生じがちです。 

### PDEの数値解（Numerical solutions to Partial Differential Equations）

スペクトルベース手法の制約を回避する有力な方法は、ナビエ–ストークス方程式の2次元版を数値アルゴリズムで直接シミュレートすることです。簡略化した波動方程式（Kass and Miller 1990; Thuerey et al. 2010; Yang et al. 2016）や薄板方程式（Yu et al. 2012）を離散化する手法もあります。これらの簡略化方程式は実装しやすい一方で、得られる挙動は実際の水波とは本質的に異なります。Tessendorf（2004a; 2014）は線形化ベルヌーイ方程式を離散化し、より現実的な分散を示しますが、それでも物理的に正しい運動には至りません（Canabal et al. 2016で議論）。また、格子ボルツマン法（LBM）に基づく直接数値シミュレータ（Geist et al. 2010）も提案されていますが、現実的な波速を得るにはLBMの衝突行列を注意深く調整する必要があります。畳み込みベース手法（Loviscach 2002; Ottosson 2011）は正しい分散関係の実現を狙いますが、巨大なカーネルがシミュレーション領域全体を占有してしまう実装上の難しさに直面します。近年、Canabal et al.（2016）はピラミッドフィルタと「影付き」畳み込み演算を組み合わせて、これらの困難を克服しました。 

これらの手法は、環境に関する仮定が少ないため、スペクトルベース手法より柔軟である傾向があります。たとえば、スペクトルベース手法は周期境界を仮定して導出されるため障害物相互作用が苦手ですが、直接シミュレーション手法にはその制約がありません。一方で、これらの手法では、時間パラメータを余弦関数に代入するだけで済むわけではなく、局所カーネル演算を反復して波の伝播を表現する必要があります。これらの手法はいずれも、波高と運動量をオイラー的な格子／メッシュ上に直接離散化するため、格子の解像度が波の可視ディテール量に直結します。ナイキストの定理により、高さ場の最高周波数を解像できるだけ格子を細かくしなければ、エイリアシングや不安定性が生じ得ます。同様に、陽解法で積分する波シミュレーションの安定性はCFL条件によって格子間隔と密接に結び付けられます。これは陰解法によって回避できますが、追加計算と、より複雑でGPU向きでない実装を代償として支払うことになります。 

液体の完全3次元シミュレーション手法は本研究の範囲外です。関心のある読者には Bridson（2015）の書籍を参照することを推奨します。 

### ハイブリッド手法（Hybrid approaches）

本手法は、数値手法の柔軟性と、スペクトルベース手法の安定性・視覚的ディテールを組み合わせますが、同様の方向性は既に存在します。Yuksel et al.（2007）は、局所的な波頂を表し、所定の波速 (c) で移動する wave particles を提案しました。粒子サイズを多数用意し、(c) を解析的な位相速度に等しく設定すれば、このアプローチは局所的なスペクトルベース手法として見なせます。さらに Jeschke & Wojtan（2017）は、理論的な群速度で伝播し、理論的な位相速度で進む短い波列を内部に含む wave packets を導入しました。これらは、数値的安定性や理論的に正しい波速といったスペクトルベース手法の利点の一部を継承します。同時に、全域に広がる余弦波を短い波成分の列へ分割することで、障害物と相互作用できるようになり、スペクトルベース波の扱いにくさを回避します。本手法も同様の利点を提供しますが、ラグランジュ的ではなくオイラー的です（自由度が波の運動そのものではなく、空間領域に紐づく）。その結果、GPUハードウェアへより自然にマッピングでき、粒子数に依存しない一定の計算量となり、さらにテクスチャマップと容易に接続できるためアート制御にも都合が良い、という特徴があります。 

### 波のアートディレクション（Art-directing waves）

既存研究では、キーフレームを直接編集する（McNamara et al. 2004; Shi and Yu 2005）、流体を対話的に彫刻する（Manteaux et al. 2016; Pan et al. 2013）、粒子やメッシュにガイド力を導入する（Thuerey et al. 2009; Raveendran et al. 2012）、便利な流れプリミティブを合成する（Chenney 2004）、シミュレーション間や既存モーション間で補間する（Raveendran et al. 2014; Thuerey 2016）など、多様な液体制御手法が検討されてきました。また、既存アニメーションに対して表面上（Angst et al. 2008; Kim et al. 2013）や境界近傍（Jeschke and Wojtan 2015, 2017）へ追加の波を付与する研究もあります。Horvath（2015）は海洋スペクトルの制御を詳細に探究し、Nielsen et al.（2013）はスクリプト化された高さ場に基づいてスペクトルベース手法を制御する方法を調査しています。私たちの知る限り、本論文が提案するように、方向性をもつ水波の振幅を局所的にディレクションする先行手法は存在しません。 

## 3 THEORY（理論）

本節ではまず、3.1節で提案する波レットベースの水面波の新しい離散化の動機を説明します。次に3.2節で、これらの「水面波レット」の時間発展を記述する偏微分方程式を導出します。最後に3.3節で、導出の妥当性を議論し、本手法に対するいくつかの解釈を与えます。 

---

### 3.1 Motivation（動機）

現在の水面波シミュレーションの数値手法は、偏微分方程式（PDE）の離散化に基づくものか、あるいはスペクトル（周波数）ベースの手法に基づくものの、いずれかに大別されます。PDEを離散化する手法は、波の高さ (\eta(x,t)) が時間とともにどう変化するかを表す何らかの微分方程式を近似します：

$$
\frac{\partial \eta(x,t)}{\partial t} = \ldots \quad (1)
$$

ここで右辺は用いる波モデル（浅水方程式、ベルヌーイ方程式など）で定まり、環境との相互作用はPDEの境界条件として組み込まれます。これらの離散化では、(\eta(x,t)) を空間的に格子間隔 (\Delta x) のグリッド上でサンプリングします。エイリアシングを避け、高周波の細部を忠実に再現するためには、ナイキスト＝シャノンの標本化定理により、(\Delta x) は (\eta(x,t)) に含まれる最短波長の半分より小さくなければなりません。もし (\eta(x,t)) に興味深い高周波ディテールが含まれるなら、サンプルは非常に密である必要があり、結果として (\Delta x) は非常に小さくなります。実際問題として (\Delta x) を小さくするには、サンプル数を増やすかシミュレーション領域を小さくする必要があるため、ナイキストの定理は事実上、生成可能な視覚ディテールを制限します。高精細な見た目は (\Delta x) を小さくすることで得られますが、計算時間とメモリが大幅に増加します。 

一方、スペクトルベースの水面波アニメーション手法は、空間の離散化そのものを避けることでこれらの問題を回避します。これらは線形波理論に基づき、波の高さのダイナミクスを偏微分ではなく周波数の形で記述します：

$$
\eta_c(x,t)=\int_{\mathbb{R}^2} A(k), e^{i(k\cdot x-\omega(k)t)}, dk \quad (2)
$$

ここで (\eta_c(x,t)) は2次元空間と時間で変化する複素関数で、実際の波高はその実部 (\eta(x,t)=\mathrm{Re},\eta_c(x,t)) として得られます。波数ベクトル (k) は2次元の周波数で、波数（スカラー）(k=|k|) は周波数の大きさ、(\hat{k}=k/k) は波の進行方向を表します。指数項は進行波を表し、(A(k)) はその振幅です。角周波数は

$$
\omega(k)=\sqrt{gk+\sigma k^3}\quad (3)
$$

であり、波数 (k)、重力 (g)、表面張力 (\sigma) に基づく各波の速度を符号化します。スペクトルベース手法は、微分方程式を離散化する代わりに、これら2次元波の全体にわたる積分を離散化して波高を計算します。この解は、周期的領域で境界や相互作用する障害物がない理想状況では完全に機能しますが、制約が緩い状況では非現実的、あるいは不可能になります。 

まとめると、PDEベース手法は複雑な環境相互作用を伴う低周波の波動関数のシミュレーションに優れ、スペクトルベース手法は境界相互作用のない単純な運動をする高精細（高周波）な波動関数のシミュレーションに適しています。次節では、低周波の運動を離散化PDEでシミュレートし、高周波をスペクトル手法で扱うハイブリッドな離散化を導出します。これにより、(\Delta x) よりはるかに短い波長が複雑環境と相互作用する様子を扱いつつ、高精細波のシミュレーションに伴う前述の問題を取り除きます。 

導出にはガボール波レット変換を用います。これは式(2)（振幅 (A) が (k) のみに依存し、(x,t) に依存しない）を、振幅が (k,x,t) に依存する類似式へと実質的に変換します：

$$
\eta_c(x,t)=\int_{\mathbb{R}^2} A(x,k,t), e^{i(k\cdot x-\omega(k)t)}, dk \quad (4)
$$

この空間的に変化する振幅 (A(x,k,t)) は、(A(k)) と比べてより局所的な制御を可能にするだけでなく、(\eta(x,t)) よりも低い周波数成分しか持たないことが保証されることを示します。この事実を利用して、ナイキスト限界に関連する問題を回避し、非常に効率的かつ高精細な波シミュレーションを実現します。 

---

### 3.2 Derivation（導出）

水面高さ (\eta_c) のガボール変換は次で与えられます：

$$
\zeta(x,k,t)=\frac{1}{(2\pi)^2}\int_{\mathbb{R}^2}\eta_c(y,t), e^{-\frac{|y-x|^2}{2s^2}}, e^{-ik\cdot y}, dy \quad (5)
$$

ここで被積分関数の第1指数は位置 (x) を中心とする標準偏差 (s) のガウス、第2指数は波数ベクトル (k) を持つ静的な波です。式(5)は (\eta_c) とガウス波レットの内積とみなせるため、(\zeta(x,k,t)) は「点 (x) 近傍で (\eta_c) が波数 (k) の波にどれだけ似ているか」を表します。 

ガボール変換は逆変換もできます：

$$
\eta(x,t)=\mathrm{Re}\int_{\mathbb{R}^2}\zeta(x,k,t), e^{ik\cdot x}, dk \quad (6)
$$

これは (\zeta) が (k) に加えて (x,t) にも依存する振幅として振る舞うフーリエ変換を想起させます。そこで変数変換 (A(x,k,t)=\zeta(x,k,t)e^{i\omega(k)t}) を導入すると、式(2)の動的波の表現に対応する形として：

$$
\eta(x,t)=\mathrm{Re}\int_{\mathbb{R}^2}A(x,k,t), e^{i(k\cdot x-\omega(k)t)}, dk \quad (7)
$$

が得られます。ここで (A) は、波数ベクトルに加えて空間と時間にも依存する振幅の役割を果たします。式(2)を式(5)へ代入すると、(A) の時間発展は

$$
A(x,k,t)=\int_{\mathbb{R}^2}\tilde{A}(l,k), e^{i((l-k)\cdot x-(\omega(l)-\omega(k))t)}, dl \quad (8)
$$

$$
\tilde{A}(l,k)=A(l), s^2, e^{-\frac{1}{2}s^2|l-k|^2} \quad (9)
$$

となります。式(8)は (A) の発展を完全に規定しますが、積分形であるため境界条件の導入が難しく、一般に離散化もしづらいので、微分方程式形を導出します。式(8)を時間微分し、空間微分で表すことで、分散関係を (\omega(l)\approx\omega(k)+\omega'(k),\hat{k}\cdot(l-k)) と線形化すると、(A) の発展は一次の偏微分方程式として

$$
\frac{\partial A}{\partial t}(x,k,t)=-\omega'(k),(\hat{k}\cdot\nabla_x),A(x,k,t) \quad (10)
$$

を得ます。これは振幅関数 (A(x,k,t)) が、方向 (\hat{k}) に、速度 (\omega'(k)) で空間的に移流されることを意味します。この速度は、水面波エネルギーを輸送する群速度に一致します。より詳細な導出は付録Aで与えます。 

式(10)には境界条件が伴います：

* 透過境界では (A(x,k,t)=A_{\mathrm{ambient}}(x,k,t))
* 反射境界では (A(x,k,t)=A(x,k_{\mathrm{reflect}},t))  … (11)

ここで (A_{\mathrm{ambient}}) は領域外で定義された振幅関数、(k_{\mathrm{reflect}}=k-2(n\cdot k)n) は法線 (n) を持つ境界で反射した波数ベクトルです。この反射境界条件は、平面波が直線境界で反射する挙動に基づきます。式(7)と式(10)が水面波をシミュレートする上での主要要素です。実際のインタラクティブ・シミュレータは各タイムステップで式(10)により (A) を移流し、レンダラは必要に応じて式(7)で水面を再構成します。この枠組みでは (A) が主要なシミュレーション変数であり、(\eta) は後段で再構成・可視化のために使われます（シミュレーションが (A) を更新し、その後 (A) を各波の振幅として多数の波を和算して (\eta) を計算します）。 

なお、式(5)のガボール変換は導出のために用いているだけで、実際に計算する必要はありません。同様に、ガウスのサイズ (s) は式(7)(10)には現れないため、解析には有用でも数値手法上のパラメータではありません。式(7)(10)をどのように離散化するかは4節で説明します。 

---

### 3.3 Discussion（議論）

**近似の精度**：式(10)は真の発展を線形化した近似であり、(l) が (k) に近いときのみ妥当です。しかし式(9)のガウス項により、(l) が (k) から離れると (\tilde{A}) は小さくなるため、この近似による (A) の誤差は指数的に小さくなります。さらに、反射境界条件は幾何光学に基づくため、波長とパケットサイズ（パラメータ (s) で表現）が境界曲率に比べて小さい場合にのみ妥当です。曲率の大きい境界をより正確に扱うには散乱効果を考慮する必要がありますが、これは将来課題とし、視覚的にもっともらしい結果を得るには本稿の単純な反射境界条件で十分だと述べます。 

**低周波な (A)**：付録Bで、(A) のフーリエ変換は (\eta) のフーリエ変換を実質的にローパスしたものになっていることを示します。言い換えると、低周波の変数だけで波高 (\eta) を再構成できます。これは離散化に重要で、ナイキスト限界のため高周波な (\eta) を粗いグリッドで直接離散化するとエイリアシングが生じますが、(A) は粗いグリッドでも離散化が可能です。つまり、グリッド解像度が「見える波」の解像度を直接制限するのではなく、本アルゴリズムでは「波の振幅（(A)）」の解像度に制限がかかります。振幅は直接可視化されないため、知覚的にも識別が難しい（＝粗くしても破綻しにくい）と考えられます。 

**位相シフト**：ガボール変換により、局所振幅だけでなく位相の観点からも波高を議論できます。式(7)で各波レットの位相は (k\cdot x-\omega(k)t) で決まります。もし (\eta(x,t)) を (\eta(x-y,t)) に置き換えて空間的に平行移動すると、右辺には (-k\cdot y) の位相シフトが生じます。(k) が大きいほど、小さな空間シフトが大きな位相シフトにつながります。したがって、振幅 (A) は粗いグリッドでも扱いやすい一方で、位相は依然としてナイキスト限界に敏感で、正確な再構成には低周波（小さな (k)）か、非常に多くの (k) サンプルが必要です。あるいは干渉パターンの厳密さが不要であれば、各波方向ごとに固定のランダム初期位相 (\xi(\hat{k})) を加えることでエイリアシングを回避できます：

$$
\eta(x,t)=\mathrm{Re}\int_{\mathbb{R}^2}A(x,k,t),
e^{i\left(k\cdot x-\omega(k)t+\xi(\hat{k})\right)}, dk \quad (12)
$$ 

**ハイブリッド・シミュレーション**：3.1節では本手法をスペクトル手法とPDE手法のハイブリッドとして動機づけましたが、その性質はガウスサイズ (s) を考えるとより明確になります：

$$
A(x,k,t)\rightarrow A(k)\quad \text{as } s\rightarrow\infty \quad (13)
$$

$$
\frac{1}{s^2}A(x,k,t)\rightarrow \eta_c(x,t), e^{-i(k\cdot x-\omega(k)t)}
\quad \text{as } s\rightarrow 0 \quad (14)
$$

(s\to\infty) ではガウスが空間一定となり、手法は従来のスペクトル法へ移行します。一方 (s\to 0) ではガウスがディラックのデルタとなり、本手法は波高 (\eta) に似た関数を計算します。離散化では (s) を直接設定しませんが、実質的には格子間隔 (\Delta x) によって決まります。したがって、本手法は単一グリッドセル内ではスペクトル法に似ており、ズームアウトするとPDE離散化に似た振る舞いになります。 

**Wave Packets との関係**：3.2節ではガボール変換で導出しましたが、付録Cでは Jeschke & Wojtan [2017] の波パケットから別の導出も可能であることを示します。式(7)は、全ての位置・波数にまたがる無限個の波パケットの極限として現れると示されます。この観点では、Jeschke & Wojtan [2017] は本稿の連続理論に対するあるラグランジュ的離散化（少数のパケットをサンプルし、その伝播を追跡）を提示したと見なせます。対して式(10)は、各点での波パケット内容の変化を追跡するオイラー的参照枠です。さらに付録Cでは、(A) は近傍の波パケット振幅の滑らかな平均として現れ、(A) が空間的にゆっくり変化する滑らかな関数である追加の根拠になります。 

## 4 離散化（DISCRETIZATION） 

3.2節では、新しい振幅関数 (A(x,k,t))、それを時間発展させる方程式（式(10)）、そして水面波の高さを計算する方程式（式(7)）を導入しました。本節の残りでは、これらの考え方を効率よく水面波をシミュレートできるように、どのように離散化するかを説明します。

---

### 4.1 (A) の離散化 

振幅 (A(x,k,t)) は **4+1 次元**の関数です（空間2次元、波数ベクトル2次元、時間1次元）。ここでは波数ベクトルを極座標
[
k=(k\cos\theta,;k\sin\theta)
]
で表すのが直感的で、計算上も便利だと考えます。ここで (k) は (|k|)（大きさ）、(\theta) は (k) と (x) 軸のなす角です。

私たちは (A) を、4次元グリッド
[
[x_{\min},x_{\max}]\times[y_{\min},y_{\max}]\times[0,2\pi)\times[k_{\min},k_{\max}]
]
上で表現します。これは空間座標 (x,y)、角度 (\theta)、波数 (k) を張るものです。グリッドの各ノード（座標 (a,b,c) で添字づけ）に (A) のサンプルを保持します。離散サンプルは
[
A_{abc}
]
で表し、これは位置 (x_a=(x_a,y_a))、角度 (\theta_b) の方向へ進み、波数 (k_c) をもつ波レットの振幅サンプルです（図2参照）。

このとき (A) は、有限要素法の流儀で基底関数の線形結合として近似できます：
[
A(x,k,t)=\sum_{a,b,c} C(A_{abc},t),\phi_a(x),\vartheta_b(\theta),\psi_c(k). \tag{15}
]
ここで (\phi_a(x)) は位置の基底、(\vartheta_b(\theta)) は角度の基底、(\psi_c(k)) は波数の基底、(C(A_{abc},t)) は離散値 (A_{abc}) を重みづける係数関数です。

たとえば全次元で区分線形基底を使うなら (C(A_{abc})=A_{abc}) とでき、
[
A(x,k,t)=\sum_{a,b,c} A_{abc}(t),\phi_a(x),\vartheta_b(\theta),\psi_c(k) \tag{16}
]
となり、基底関数は近傍の (A_{abc}) を重みづける“ハット関数”になります。

基底関数に対する実用上の唯一の制約は、（半ラグランジュ移流などが期待通り動くために）再構成関数が離散サンプルを**補間**すること、すなわち
[
A(x_a,\theta_b,k_c,t)=A_{abc}(t)
]
を満たすことです。位置基底 (\phi_a(x)) は空間方向の補間で、標準的な区分線形／区分三次基底を使います。角度方向の (\vartheta_b(\theta)) は進行方向間の補間で、ここでは区分三次基底を使います。

波数基底 (\psi_c(k)) には特別な物理的解釈があります。これは (A_{abc}) が表す波の**スペクトル形状**に対応します。波束（wave packet）の類推を続けるなら、(\psi_c(k)) は「位置 (x)、方向 (\theta)、代表波数 (k_c) をもつ波束が、周波数空間でどんな形をしているか」を記述します。区分定数なら“平坦なスペクトル”、区分線形なら (k_c) にピークを持つより波束らしい形、ガウスなら典型的な波束導出に近い形になります。

(\psi_c(k)) には任意のスペクトルを割り当てられますが、本論文では水面波を扱うので、(\psi_c(k)) として実際の海洋波スペクトルを使うのが適切だと判断しました。例では Horvath 2015 の式(32)の方向スペクトルを (\psi_c(k)) にし、(A(x_a,\theta_b,k_c,t)=A_{abc}(t)) となるよう正規化しています。

実際には驚くほど粗いグリッドでも十分でした。角度は (\Theta_A=16) サンプルで、細かくしても品質は上がりませんでした。波数 (k) はさらに少なく、通常は (K_A=1) サンプルで狙った効果が出ます（8章では最大 (K_A=4) まで実験）。また (A) は空間的にゆっくり変化するので、空間分解能もそれほど要りません。実装では各空間次元に (X_A=4096) グリッドセルを割り当て、セル間隔はおよそ1mになります。

さらに本論文のシミュレーションでは、初期条件として実数値の (A) を使っています。式(10)によりこの関数は時間が経っても実数のままなので、複素数係数 (A_{abc}) を保持する必要はない、としています。

---

### 4.2 移流（Advection）の離散化 

波数ベクトル (k) をすべて離散化すると、式(10)は空間上の**独立なスカラー移流方程式**（各 (k) サンプルごとに1本）になります。これらを GPU 上で並列に、Fedkiw らの「傾き制限付き三次補間を用いた無条件安定な半ラグランジュ移流」で数値積分します：

[
A_{abc}(t+\Delta t)=A_{bc}!\left(x_a-\Delta t,\omega'(k_c),\hat{k}*b,;t\right). \tag{17}
]
ここで (A*{bc}) は角度 (\theta_b) と波数 (k_c) を固定したときの (A) の補間関数、(\hat{k}_b=(\cos\theta_b,\sin\theta_b)) は方向、(x_a=(x_a,y_a)) です。

半ラグランジュの逆追跡レイが領域外へ出る場合は、式(11)の境界条件を使って式(17)右辺の値を差し替えます。透過境界では周囲の海の挙動を表す手続き的な (A_{\text{ambient}}) を与え、反射境界では境界でレイを反射して新しい位置 (x_{\text{reflect}}) と方向 (k_{\text{reflect}}) を得て、反射後の値 (A(x_{\text{reflect}},k_{\text{reflect}},t)) で更新します。

**振幅の拡散（Amplitude Spreading）**：(\theta_b) や (k_c) が異なると進行方向や速度が異なるため、時間が経つと振幅が分離して、良い初期状態が「ばらけた振幅の塊」になってしまいます（図3左）。これは有限個の波数ベクトルで式(10)を離散化することによる問題なので、次の2つの拡散項を追加します：

[
\frac{\partial A}{\partial t}
= -\omega'(k)(\hat{k}\cdot\nabla_x)A
+\delta,(\hat{k}\cdot\nabla)^2A
+\gamma,\frac{\partial^2 A}{\partial\theta^2}. \tag{18}
]
(\delta) は進行方向への拡散（分散で波束が伸びる効果の模倣）を、(\gamma) は角度方向の拡散（点源から放射状に広がるような接線方向の広がりの模倣）を制御します。他の拡散項も可能ですが、この2項が非常にうまく動くと述べています（図3右は角度拡散の効果）。

数値解法は演算子分割です：移流は上の半ラグランジュ法、拡散は空間2次の有限差分＋時間前進オイラーです。例では拡散係数を移流速度 (\omega')、空間解像度 (\Delta x)、波数解像度 (\Delta k)、角度解像度 (\Delta\theta) に対して
[
\gamma = 0.025,\omega'(k),\Delta\theta^2/\Delta x,\quad
\delta = 10^{-5},\Delta x^2,\Delta k^2,|\omega''(k)|
]
と設定しています。

---

### 4.3 高さ場（Height field）の評価 

実際の水面高さを求めるには、式(12)の積分を数値的に評価します。波数を極座標で評価すると
[
\eta(x,t)=\operatorname{Re}\int_0^{2\pi}\int_0^{\infty}
A(x,k,t),e^{,i(,k\cdot x+\xi(\hat{k})-\omega(k)t,)},k,dk,d\theta \tag{19}
]
となります。

さらに (A) の離散形を代入すると
[
\eta(x,t)=\int_0^{2\pi}\sum_{a,b,c} C(A_{abc},t),\phi_a(x),\vartheta_b(\theta),
\Psi_c!\big(\hat{k}\cdot x+\xi(\hat{k}),t\big),d\theta \tag{20}
]
となり、ここで
[
\Psi_c(p,t)=\int_0^{\infty}\psi_c(k)\cos(kp-\omega(k)t),k,dk \tag{21}
]
です。式(21)から分かるように、(\psi_c(k)) は高さ評価において各波数 (k) の振幅として働き、(A_{abc}) に紐づくスペクトルそのものとして扱われます。

実装では、各タイムステップの冒頭で (\Psi_c(p,t)) を複数のサンプル点 (p_i) で評価して **1Dテクスチャ**に格納します。これを “profile buffer” と呼び、この事前計算によって高価な積分評価を、その後のステップ中は単なるテクスチャ参照に置き換えられます。事前計算後、式(20)の1次元積分を複数角度の総和で近似することで、任意位置で (\eta) を評価できます。

例のパラメータは、式(21)の事前計算で波数を (K_\eta=400) 個足し合わせ、結果 (\Psi_c) をサイズ (N=4096) の1Dテクスチャに格納し、各点での (\eta) 評価は (\Theta_\eta=120) 方向の総和で行います。なお、(A) の離散化で使う方向数・波数数と、(\eta) の積分で使うそれらは、かなり独立に選べます（表1）。

また、トロコイド型の Gerstner 波を模倣するため、profile buffer (\Psi_c) で垂直変位に加えて水平変位も計算し、その水平変位を最終的な (\eta) の総和に含めています。

計算量について、素朴に式(19)を全点で評価すると (O(K_\eta\Theta_\eta X_A^2)) かかりますが、profile buffer により (O(K_\eta+\Theta_\eta X_A^2)) に落ち、GPU コア数 (G) によりさらに (O(K_\eta+\Theta_\eta X_A^2/G)) になります。実際、この導入で (\eta) の評価は 1.8fps → 275fps へ上がり、233倍の高速化になったと報告しています。

## 5 アルゴリズム概要（ALGORITHM SUMMARY） 

本節では、本手法を実装するために必要な手順の概要を示します。また、（公開時に）本アルゴリズムの分かりやすい（CPUのみの）実装例コードを提供する予定であり、さらに本投稿には GPU 最適化版の実装を実演する実行ファイルも含めています。

本アルゴリズムの主目的は、振幅 (A)（式(10)）を更新し、それを用いて水面高さ (\eta)（式(7)）を可視化することです。物理シミュレーションのほとんどは振幅の計算に含まれており、(A) 自体は直接可視化しません。一方で (\eta) の計算は（事前計算した profile buffer のおかげで）比較的軽く、その可視化が波シミュレーションの見かけ上の細部のほとんどを担います。この非対称性を活かすため、(A) は粗いグリッド上で計算し、(\eta) は視点に依存して適応的に細分化される詳細メッシュ上で計算します。具体的に GPU 最適化版では、ハードウェアテッセレーションを用いて (\eta) で決まる頂点位置から適応三角形メッシュを生成し、ピクセルシェーダで (\eta) の解析的な空間微分から法線を計算します。

本アルゴリズムは、各タイムステップで1回だけ前処理を行う **TimeStep** 関数と、細密サンプル格子の各ノードおよび各ピクセルに対して必要に応じて評価される **WaterHeight** 関数に分けます。TimeStep は主に発展方程式(18)を、(1) 4.2節の半ラグランジュ移流を計算する **AdvectionStep** と、(2) 振幅の拡散（amplitude spreading）を計算する **WavevectorDiffusion** の2つに分割して解きます。最後に **PrecomputeProfileBuffers** により、水面高さ評価（4.3節）で用いる1次元の波形 profile buffer (\Psi_c(p,t)) を事前計算します。WaterHeight は 4.3節と同様に、異なる角度での1D波形を重み付きで合計することで式(20)を数値評価します。擬似コードはアルゴリズム1を参照してください。

---

### アルゴリズム1：本論文で用いるアルゴリズムの擬似コード 

````text
function TimeStep(t)
    AdvectionStep(t)
    WavevectorDiffusion(t)
    Ψ ← PrecomputeProfileBuffers(t)
end

function WaterHeight(x, t)
    η ← 0
    b ← 1 から Θη まで繰り返す
        θb ← (2π / Θη) * b
        k̂ ← (cos θb, sin θb)
        p ← k̂ · x + rand(b)
        c ← 1 から Kη まで繰り返す
            η ← η + A(x, kc * k̂) * Ψc(p, t)
        end
    end
end
````

# 9 DISCUSSION

本論文では、水面波のアニメーション化のための新しいウェーブレットベースの離散化手法を提案する。この手法は線形波動理論に基づいているため、振幅の小さい波の正しい挙動を近似することしかできず、非線形効果を捉えることができない。主要な力学方程式である式10または式18は、Aの線形微分方程式である。本手法は、ビーゼル波やゲルストナー波のような高さ場以外の変位効果を扱うことができるが、砕波や飛沫のようなトポロジー変化のような複雑な非線形現象を直接扱う方法はない。

このアプローチは、可視化された波の解像度とシミュレーションの解像度を切り離します。新たなガボール変換を用いることで、シミュレーションの解像度を、最終的に可視化されるハイトフィールドの解像度よりもはるかに低く抑えることができます。
したがって、このアプローチは、過剰な計算、エイリアシング、シミュレーションの安定性といった一般的な問題を伴わずに、非常に高い周波数の波をアニメーション化することができます。

オイラー高度場ベースのシミュレーションと比較すると、本手法は、4 km x 4 km のシーンに対して、4096^2
(空間解像度) × 16 (波数ベクトル解像度) のサンプルを保存します。同じサンプル数を保存する高度場は、グリッドセルごとに 2 つの値を保存する必要があることを考慮に入れなくても、グリッドセル間隔は 25 cm になります。ナイキスト定理に従うと、最小波長は 0.5 m になります。比較のため、本手法では 2 cm までの波長をアニメーション化します。

ウェーブパケット [Jeschke and Wojtan 2017] と比較すると、隣接する重なり合うウェーブパケットはレンダリング中に大量のピクセルオーバードローを引き起こし、パフォーマンスを大幅に低下させます。この問題を簡単に解決する方法はありません。パフォーマンスの違いを示すために、1つのボートの航跡には2～6ミルのウェーブパケットが必要で、レンダリング時間はそれぞれ2～0.5 FPSです。対照的に、私たちの手法では、同じハードウェア上で1000隻のボートの航跡を60 FPSでシミュレートしてレンダリングします。当然、計算コストは​​一定で、シミュレートされる波の数に依存しません。ただし、ウェーブパケットのボートの航跡は、個々の波の位相が明示的に制御されるため、物理的により正確です。目安として、波の位相（例えば、完全に円形の波紋）の制御が重要で、パケット数が多すぎない場合は、ウェーブパケットを使用する必要があります。表面ウェーブレットは、物理的な精度よりも妥当性が重視される中規模スケールでも、インタラクティブな水シミュレーションには明らかに優れた選択肢です。

本手法は、低解像度のシミュレーションであっても、高周波水波の集合的な動きを効率的にシミュレートできます。
しかし、3.3節で述べたように、低解像度のシミュレーションでは、各波の位相を正確に制御することができません。そのため、雨滴から放出される完全な円形の波面のように、コヒーレントな位相に依存する現象を、シミュレーション解像度を上げずにシミュレートすることは困難です。同様に、コヒーレントな位相間の建設的干渉に依存する多くの一般的な航跡パターン[Jeschke and Wojtan 2017; Thomson
1891]は、本手法では再現できません。低解像度では、提案するジッタ位相は、カオス的な飛沫、風、大型浮遊物などのノイズの多い波源に適しています。今後の研究により、波の位相のコヒーレンスとシミュレーション解像度の間のこの関連性が解消されることを期待しています。

現在の実装では深水分散関係を使用しています。将来的には、この研究を拡張して、より一般的な深度依存の分散関係を扱えるようにしたいと考えています。これにより、浅水付近で追加の屈折効果が生じるはずです。

全体として、空間依存の振幅をシミュレートするという私たちのアプローチは、水波シミュレーションに興味深い工夫を凝らしていると考えています。
この新しい方向性は、次元の増加や位相と解像度の興味深い関連性など、独自の課題をもたらします。
同時に、このアプローチは物理ベースアニメーションの分野における未解決の課題に大きく前進をもたらします。
芸術的な制御のための新しい手法を導入し、極めて広大なシミュレーション領域を可能にし、
優れた空間解像度を備えたインタラクティブなアニメーションを可能にします。

