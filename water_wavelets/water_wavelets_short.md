# Water Wavelets

## 概要

水面波をリアルタイムに扱うとき、従来は大きく **2択**でした。
(1) **フーリエ（スペクトル）系**：広大な海面に高周波ディテールを載せるのは得意だが、**移動する障害物や局所的な環境相互作用**（移動境界・局所的な風など）を入れにくい。
(2) **PDE（有限差分/有限要素など）系**：障害物相互作用は得意だが、**高周波ディテール**を保ったまま巨大領域へスケールすると、**CFL条件**や**ナイキスト限界**に縛られて計算が重くなる。  

本論文はこのギャップを埋めるために、波の状態を「高さ場 (\eta(x,t)) を直接更新する」代わりに、**空間 (x)・方向/周波数 (k) にまたがって定義される“局所振幅” (A(x,k,t))** として表現する、**新しいウェーブレット（Eulerian Wavelet Transformation）**を提案します。直感的には、海面を「無限に広がる正弦波の足し算」でも「細かい格子の高さ更新」でもなく、**“その場所にどんな向き・どんな波長の波がどれくらい居るか”の分布**として持つイメージです。  

この表現の核は、(A) が **高さ場より空間的にゆっくり変化する**ため、シミュレーション自体は **粗いグリッド**で回せる点です。つまり、見た目の細部（高周波）は後段の再構成で出しつつ、シミュレーションは低周波な変数で安定・高速に行えるので、結果として **CFL/ナイキスト由来のボトルネックを大きく緩和**できます。しかも (A) の時間発展は主に **2Dの移流＋拡散**の形になり、GPUで並列化しやすいので対話的フレームレートを狙える、という主張です。  

その結果として本手法は、**(a) 高解像ディテールを保った広域の波**と **(b) 移動障害物など局所相互作用**を同時に扱えることを目標にしています。さらに拡張として、**事前計算した波の経路**や **双方向の固体–流体カップリング**も示し、加えて (A) が「局所的な方向付き振幅」という扱いやすい変数であることを活かして、物理を上書きする **“波を描く（wave-painting）”** 的なアート制御インタフェースも提案します。  

## 関連研究

水面波アニメーションは大きく **(1) スペクトル（フーリエ）系**, **(2) PDE（偏微分方程式）を直接解く数値系**, **(3) そのハイブリッド**, そして **(4) アートディレクション（制御）**の文脈に整理できる、という立て付けです。 

### 1) スペクトル（フーリエ）系

深水・小振幅・ポテンシャル流・周期境界などの仮定で水面を正弦波の重ね合わせとして表し、**広域に高周波ディテールを出すのが得意**です。
ただし、導出が周期境界などの仮定に強く依存するため、**複雑境界や移動障害物、空間的に変化する外力（風など）を自然に入れにくい**のが弱点。静的環境で境界を扱う拡張はあるものの、**事前計算前提で移動物体は扱えない**と述べています。  

### 2) PDEの直接数値解（有限差分/有限要素/近似モデルなど）

ナビエ–ストークスの2D版や、その簡略化（波動方程式・薄板方程式等）を格子上で解く系です。
**境界や障害物相互作用に強く、環境に対する仮定が少ない**一方で、波高や運動量を格子に直接持つため、**格子解像度がそのまま見た目ディテールと安定性を縛る**（ナイキスト限界、CFL条件）。陰解法で緩和できるが、計算が重くGPU向きでない、という整理です。 

### 3) ハイブリッド（粒子/波束など）

スペクトルの「正しい波速・安定性・高ディテール」と、数値解の「局所相互作用」を両立しようとする系として、

* **wave particles**（局所的な波頂が所定速度で進む）
* **wave packets**（短い波列を含むパケットが群速度/位相速度で進む）
  などが挙げられています。
  これらは「全域に広がる正弦波」を局所要素に分割することで障害物と相互作用できるようにする発想。対して本論文は、同じ方向性を **ラグランジュ（粒子追跡）ではなくオイラー（格子上の場）**で実現し、**GPU実装・一定計算量・テクスチャ連携・アート制御のしやすさ**を利点として位置付けています。 

### 4) 波のアートディレクション

既存の流体制御は、キーフレーム編集、彫刻的編集、ガイド力、プリミティブ合成、補間、既存アニメへの波の付加、海洋スペクトル制御、スクリプト化高さ場でスペクトル法を操る…など多彩。
ただし著者らは、**“方向性をもつ水波の振幅を局所的に直接ディレクションする”**という点では先行が見当たらない、と主張しています。 

## THEORY（理論）要約（分かりやすく）

### 1) 何が問題で、何を狙うのか（動機）

従来の水面波は大きく2系統です。

* **PDEを格子で解く系**：障害物などの相互作用は入れやすいが、細かい波（高周波）まで出そうとすると、格子を細かく＆時間刻みを小さくする必要が出て重くなる（ナイキスト限界・CFL条件）。 
* **スペクトル（フーリエ）系**：高周波ディテールや大域は得意だが、移動境界や局所的な外力など「場所ごとに違う相互作用」を入れにくい。 

そこで本論文は、波を「高さ (\eta(x,t)) を直接更新」するのではなく、**“その場所 (x) に、方向・波数 (k) の波がどれだけ居るか”**を表す **局所振幅 (A(x,k,t))** を主変数にする発想を導入します。これにより、シミュレーション側は“ゆっくり変化する変数”を扱えるので、粗いグリッドでも高精細な見た目を出しやすくする、という狙いです。 

---

### 2) どういう数式になるのか（導出の要点）

ガボール変換（ガウス窓付きの局所フーリエ）で、波を「局所的に波数 (k) の成分がどれだけあるか」を表す量 (\zeta(x,k,t)) として捉えます。ここから位相項を分離して **(A(x,k,t))** を定義すると、波高は概ね

* **水面の再構成**：
  [
  \eta(x,t) \approx \mathrm{Re}\int A(x,k,t),e^{i(k\cdot x-\omega(k)t)},dk
  ]
* **(A) の時間発展**：分散関係を局所線形化すると、
  [
  \frac{\partial A}{\partial t} = -\omega'(k),(\hat{k}\cdot\nabla_x)A
  ]
  となり、**(A) は方向 (\hat{k}) に、速度 (\omega'(k))（群速度）で移流するだけ**、というとても単純な形になります。 

境界条件もこの枠組みに素直に入れられます：領域外は「外洋の (A_{\text{ambient}})」を与える（透過）、反射境界では **波数ベクトルを鏡面反射した (k_{\text{reflect}})** に写して扱う、という形です。 

---

### 3) この理論の見どころ・注意点（議論）

* **近似の妥当性**：導出は「(k) 近傍での線形化」を使う近似ですが、ガウス窓の効果で遠い成分は寄与が小さく、誤差は抑えられる、という説明です。反射境界も幾何光学的近似なので、強い曲率などは将来課題。 
* **(A) は低周波になる**：付録で「(A) は (\eta) を実質ローパスしたもの」になることを示す、と述べており、だから粗い格子で (A) を持っても破綻しにくい、というのが本手法の肝です。 
* **位相は別問題**：振幅は粗くても良いが、位相は高周波ほど敏感。厳密な干渉が不要なら、方向ごとにランダム位相を足してエイリアシングを避ける案（式(12)）を提示します。 
* **ハイブリッドとしての位置づけ**：ガウスサイズ (s) の極限で「スペクトル法っぽくもPDEっぽくも見える」ことを示し、両者の橋渡しとして捉えています。 
* **Wave packets との関係**：波パケット系（Jeschke & Wojtan 2017）を、少数パケットを追うラグランジュ離散化だと見るなら、本手法は「各点のパケット内容を追うオイラー形式」だ、という整理です。 

要するにTHEORYは、「**局所方向付き振幅 (A)** に変数変換すると、更新はほぼ **移流（群速度）** になって軽くなり、しかも (A) が低周波なので粗い格子で持てる。そこから高精細な水面は後で再構成する」という骨格を作っている章です。  

## 5 ALGORITHM SUMMARY（アルゴリズム概要）要約（分かりやすく）

この章は「結局、実装では毎フレーム何をやるの？」を **2つの関数**に分けて整理しています。核は、**物理は (A) を更新することに集約**され、**見た目（(\eta)）は高速に再構成**する、という非対称な設計です。 

---

### 全体像：やることは2つだけ

1. **TimeStep(t)**：1フレーム（1タイムステップ）につき1回だけ実行。
   → **局所振幅 (A)** を更新し、描画で使う下準備（profile buffer）を作る。

2. **WaterHeight(x,t)**：必要な場所で何度も呼ばれる（頂点/ピクセルごと）。
   → 更新済みの (A) と profile buffer から **水面高さ (\eta)** を計算する。 

---

### 1) TimeStep(t) の中身（物理の本体）

TimeStep は発展方程式(18)を、演算子分割で次の2段にして解きます。 

* **AdvectionStep(t)**
  各方向・波数成分の (A) を、群速度方向へ **半ラグランジュ移流**で更新。

* **WavevectorDiffusion(t)**
  離散化の副作用で (A) が「ばらける（amplitude spreading）」のを抑えるための **拡散**（進行方向＋角度方向）を適用。

最後に、

* **PrecomputeProfileBuffers(t)**
  4.3節の (\Psi_c(p,t)) を計算して **1Dテクスチャ（profile buffer）**に入れ、以降の (\eta) 計算を「テクスチャ参照＋和」へ置き換えます。 

---

### 2) WaterHeight(x,t) の中身（描画側の評価）

WaterHeight は「方向を何本かサンプルして足し合わせる」だけです。擬似コード的には：

* 方向 (b=1.. \Theta_\eta) を回す
* その方向 (\hat{k}) に対して (p=\hat{k}\cdot x + \text{rand}(b)) を作る（方向ごとのランダム位相でエイリアシングを軽減）
* 波数側（(c=1..K_\eta)）も回して
  [
  \eta ;+=; A(x, k_c\hat{k});\Psi_c(p,t)
  ]
  を足す 

ここで重い積分は profile buffer 側で済んでいるので、WaterHeight は軽く、**大量に呼んでも耐えられる**想定です。 

---

### 実装上の肝（章の主張）

* シミュレーションの本体は **(A) の更新**で、これは粗い格子で良い（=軽い）
* 見た目のディテールの大半は **(\eta) の再構成**が担うが、これは profile buffer のおかげで軽い
* GPU最適化版では、(\eta) を使って **ハードウェアテッセレーションで適応メッシュ**を作り、法線も (\eta) の解析微分から計算する、という描画パイプラインまで示しています 

要するに5章は、「**毎フレームは (A) を移流＋拡散で更新→profile buffer作成**、描画時は **方向和で (\eta) を評価**」という実装の最短ループを提示している章です。
